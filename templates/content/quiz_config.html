{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="config-container">
    <div class="config-section">
        <h3>ðŸ“š Ano Escolar</h3>
        <div class="form-group">
            <label for="year">Selecione o ano:</label>
            <select id="year" name="year">
                <option value="5" {% if quiz_config.year == 5 %}selected{% endif %}>5Âº Ano</option>
                <option value="6" {% if quiz_config.year == 6 %}selected{% endif %}>6Âº Ano</option>
                <option value="7" {% if quiz_config.year == 7 %}selected{% endif %}>7Âº Ano</option>
                <option value="8" {% if quiz_config.year == 8 %}selected{% endif %}>8Âº Ano (em construÃ§Ã£o)</option>
                <option value="9" {% if quiz_config.year == 9 %}selected{% endif %}>9Âº Ano (em construÃ§Ã£o)</option>
                <option value="10" {% if quiz_config.year == 10 %}selected{% endif %}>10Âº Ano (em construÃ§Ã£o)</option>
                <option value="11" {% if quiz_config.year == 11 %}selected{% endif %}>11Âº Ano (em construÃ§Ã£o)</option>
                <option value="12" {% if quiz_config.year == 12 %}selected{% endif %}>12Âº Ano (em construÃ§Ã£o)</option>
            </select>
        </div>
    </div>

    <div class="config-section">
        <h3>ðŸ”¢ NÃºmero de ExercÃ­cios</h3>
        <div class="form-group">
            <label for="num_exercises">Quantos exercÃ­cios pretende resolver?</label>
            <select id="num_exercises" name="num_exercises">
                <option value="2" {% if quiz_config.num_exercises == 2 %}selected{% endif %}>2 exercÃ­cios</option>
                <option value="20" {% if quiz_config.num_exercises == 20 %}selected{% endif %}>20 exercÃ­cios</option>
                <option value="40" {% if quiz_config.num_exercises == 40 %}selected{% endif %}>40 exercÃ­cios</option>
                <option value="60" {% if quiz_config.num_exercises == 60 %}selected{% endif %}>60 exercÃ­cios</option>
                <option value="80" {% if quiz_config.num_exercises == 80 %}selected{% endif %}>80 exercÃ­cios</option>
                <option value="100" {% if quiz_config.num_exercises == 100 %}selected{% endif %}>100 exercÃ­cios</option>
            </select>
        </div>
    </div>

    <div class="config-section">
        <h3>ðŸ“Š DistribuiÃ§Ã£o por Ano</h3>
        <div class="form-group">
            <label for="current_year_percent">Percentagem de exercÃ­cios do ano atual:</label>
            <select id="current_year_percent" name="current_year_percent">
                <option value="25" {% if quiz_config.current_year_percent == 25 %}selected{% endif %}>25% do ano atual</option>
                <option value="50" {% if quiz_config.current_year_percent == 50 %}selected{% endif %}>50% do ano atual</option>
                <option value="75" {% if quiz_config.current_year_percent == 75 %}selected{% endif %}>75% do ano atual</option>
            </select>
            <p class="info-text" id="distribution-info">Os restantes exercÃ­cios serÃ£o de anos anteriores para revisÃ£o.</p>
            <p class="warning-text" id="distribution-warning" style="display: none;"></p>
        </div>
    </div>

    <div class="summary-box">
        <h3>ðŸ“‹ Resumo da ConfiguraÃ§Ã£o</h3>
        <div class="summary-item">
            <span class="summary-label">Ano Escolar:</span>
            <span class="summary-value" id="summary-year">7Âº Ano</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">NÃºmero de ExercÃ­cios:</span>
            <span class="summary-value" id="summary-exercises">20 exercÃ­cios</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">Do Ano Atual:</span>
            <span class="summary-value" id="summary-current">10 exercÃ­cios (50%)</span>
        </div>
        <div class="summary-item">
            <span class="summary-label">De Anos Anteriores:</span>
            <span class="summary-value" id="summary-previous">10 exercÃ­cios (50%)</span>
        </div>
    </div>

    <div class="button-container">
        <button class="btn-start" onclick="startQuiz()">Iniciar Quiz</button>
    </div>
</div>

<script>
    // Update summary and handle edge cases
    function updateSummary() {
        const year = parseInt(document.getElementById('year').value);
        const numExercises = parseInt(document.getElementById('num_exercises').value);
        const percentSelect = document.getElementById('current_year_percent');
        let currentYearPercent = parseInt(percentSelect.value);

        const distributionInfo = document.getElementById('distribution-info');
        const distributionWarning = document.getElementById('distribution-warning');

        // Handle edge cases
        if (year === 5) {
            // Year 5: Force 100%, disable selection
            currentYearPercent = 100;
            percentSelect.value = '100';
            percentSelect.disabled = true;
            
            // Add 100% option if not present
            if (!percentSelect.querySelector('option[value="100"]')) {
                const option100 = document.createElement('option');
                option100.value = '100';
                option100.textContent = '100% do ano atual';
                percentSelect.appendChild(option100);
            }
            percentSelect.value = '100';
            
            distributionInfo.style.display = 'none';
            distributionWarning.style.display = 'block';
            distributionWarning.textContent = '5Âº Ano: Apenas exercÃ­cios do ano atual (nÃ£o hÃ¡ anos anteriores).';
            
        } else if (year > 7) {
            // Years 8-12: Force 0%, disable selection
            currentYearPercent = 0;
            percentSelect.value = '0';
            percentSelect.disabled = true;
            
            // Add 0% option if not present
            if (!percentSelect.querySelector('option[value="0"]')) {
                const option0 = document.createElement('option');
                option0.value = '0';
                option0.textContent = '0% do ano atual';
                percentSelect.insertBefore(option0, percentSelect.firstChild);
            }
            percentSelect.value = '0';
            
            distributionInfo.style.display = 'none';
            distributionWarning.style.display = 'block';
            distributionWarning.textContent = 'Anos 8-12 em construÃ§Ã£o: Apenas exercÃ­cios de anos anteriores (5Âº-7Âº ano).';
            
        } else {
            // Years 6-7: Normal operation, enable selection
            percentSelect.disabled = false;
            
            // Remove edge case options if present
            const option0 = percentSelect.querySelector('option[value="0"]');
            const option100 = percentSelect.querySelector('option[value="100"]');
            if (option0) option0.remove();
            if (option100) option100.remove();
            
            // Ensure valid selection
            if (![25, 50, 75].includes(currentYearPercent)) {
                percentSelect.value = '50';
                currentYearPercent = 50;
            }
            
            distributionInfo.style.display = 'block';
            distributionWarning.style.display = 'none';
        }

        // Calculate distribution
        const currentYearExercises = Math.round(numExercises * currentYearPercent / 100);
        const previousYearExercises = numExercises - currentYearExercises;

        // Update summary display
        document.getElementById('summary-year').textContent = year + 'Âº Ano';
        document.getElementById('summary-exercises').textContent = numExercises + ' exercÃ­cios';
        document.getElementById('summary-current').textContent = 
            currentYearExercises + ' exercÃ­cios (' + currentYearPercent + '%)';
        document.getElementById('summary-previous').textContent = 
            previousYearExercises + ' exercÃ­cios (' + (100 - currentYearPercent) + '%)';
    }

    // Add event listeners
    document.getElementById('year').addEventListener('change', updateSummary);
    document.getElementById('num_exercises').addEventListener('change', updateSummary);
    document.getElementById('current_year_percent').addEventListener('change', updateSummary);

    // Start quiz with selected configuration
    function startQuiz() {
        const year = document.getElementById('year').value;
        const numExercises = document.getElementById('num_exercises').value;
        const currentYearPercent = document.getElementById('current_year_percent').value;

        // Redirect to quiz with parameters
        window.location.href = `/quiz?year=${year}&num_exercises=${numExercises}&current_year_percent=${currentYearPercent}`;
    }

    // Initialize summary on page load
    updateSummary();
</script>