{# Macro to render option based on type and position #}
{% macro render_option(option, type_of_answer, option_index) -%}
  {% if option_index == 0 %}
    {# Index 0 is always "N√£o sei" - always plain text #}
    <span class="answer-text">{{ option }}</span>
  {% elif type_of_answer == 'latex' %}
    {# LaTeX math - wrap in \( ... \) for inline MathJax rendering #}
    {# IMPORTANT: Don't double-escape! Let Jinja render the backslashes #}
    <span class="answer-text mathjax-process">\( {{ option }} \)</span>
  {% elif type_of_answer == 'image' %}
    {# Image option - render as img tag #}
    <img src="{{ option }}" alt="option image" class="answer-image" style="width:50%; height:auto;">
  {% else %}
    {# Plain text - no processing #}
    <span class="answer-text">{{ option }}</span>
  {% endif %}
{%- endmacro %}


<div class="quiz-results-container">
<!-- Action buttons -->
<div class="results-actions">
    {% if source == 'profile' %}
        <a href="{{ url_for('profile.profile') }}" class="btn btn-secondary">Voltar ao perfil</a>
        <a href="{{ url_for('quiz.quiz_config') }}" class="btn btn-primary">Fazer um novo quiz</a>
    {% else %}
        <a href="{{ url_for('quiz.start_quiz', year=config.year, num_exercises=config.num_exercises, current_year_percent=config.current_year_percent) }}" class="btn btn-primary">
            Come√ßar de novo
        </a>
        <a href="{{ url_for('quiz.quiz_config', year=config.year, num_exercises=config.num_exercises, current_year_percent=config.current_year_percent) }}" class="btn btn-secondary">
            Alterar configura√ß√µes
        </a>
    {% endif %}
</div>
<br>
<div class="quiz-results-container">
    <div class="results-header">
        <h1>Resultados do Quiz</h1>
    </div>

    <!-- Summary cards -->
    <div class="results-summary">
        <div class="result-card result-score">
            <div class="result-value">{{ results.percentage }}%</div>
            <div class="result-label">Pontua√ß√£o Total</div>
            <div class="result-points">{{ results.total_points }} / {{ results.max_possible_points }} pontos</div>
        </div>

        <div class="result-card result-correct">
            <div class="result-value">{{ results.n_correct }}</div>
            <div class="result-label">Respostas Corretas</div>
        </div>

        <div class="result-card result-wrong">
            <div class="result-value">{{ results.n_wrong }}</div>
            <div class="result-label">Respostas Incorretas</div>
        </div>

        <div class="result-card result-skipped">
            <div class="result-value">{{ results.n_skip }}</div>
            <div class="result-label">Perguntas Saltadas</div>
        </div>
    </div>

    <!-- Detailed results - ONLY for authenticated users -->
    {% if is_authenticated %}
    <div class="results-details">
        <h2>Detalhes das Respostas</h2>
        
        {% for question_result in results.question_results %}
        {% set index = loop.index0 %}
        {% set q = question_result.question %}
        {% set result_type = question_result.result_type %}
        
            <div class="result-question-card result-{{ result_type }}">
                <!-- Header with question number and status -->
                <div class="result-question-header">
                    <div class="header-left">
                        <span class="question-number">Pergunta {{ index + 1 }} de {{ results.total_questions }}</span>
                        <span class="result-badge result-{{ result_type }}">
                            {% if result_type == 'correct' %}
                                ‚úì Correto
                            {% elif result_type == 'wrong' %}
                                ‚úó Incorreto
                            {% else %}
                                - Saltada
                            {% endif %}
                        </span>
                    </div>
                    <div class="header-right">
                        <span class="question-points">{{ question_result.points }} pontos</span>
                    </div>
                </div>

                <!-- Question image (same layout as quiz page) -->
                <div class="stage-wrapper">
                    <div class="stage">
                        <img 
                            src="{{ q.img_url }}" 
                            class="quiz-image invert-on-dark"
                        >
                        <!-- Title overlay -->
                        <!-- {% if q.title %}
                        <div class="overlay title">
                            {{ q.title }}
                        </div>
                        {% endif %} -->
                        
                        <!-- Note overlay -->
                        <!-- {% if q.note %}
                        <div class="overlay note">
                            {% if '<img>' in q.note %}
                                {{ q.note | safe }}
                            {% else %}
                                {{ q.note }}
                            {% endif %}
                        </div>
                        {% endif %} -->
                    </div>
                    
                </div>

                
                {# Note block between image and answers #}
                {% if q.note %}
                  {% set note_str = q.note|string %}
                  {% set is_img = note_str.endswith('.png') or note_str.endswith('.jpg') or note_str.endswith('.jpeg') or note_str.endswith('.gif') or note_str.endswith('.webp') %}
                  <div class="question-note-block">
                    {% if is_img %}
                      <img src="{{ note_str }}" alt="Nota" class="note-image invert-on-dark">
                    {% elif '<a ' in note_str and '</a>' in note_str %}
                    <div class="question-note-block">
                        {{ note_str | safe }}
                    </div>
                    {% else %}
                      <div class="note-text">{{ note_str }}</div>
                    {% endif %}
                  </div>
                {% endif %}

                <!-- Answer comparison section -->
                <div class="answers-comparison">
                    
                    {% if q.composed_instruction %}
                    <div class="composed-instruction">
                        <strong>{{ q.composed_instruction }}</strong>
                    </div>
                    {% endif %}


                    <h3>Respostas</h3>
                    
                    <!-- Show options with user answer and correct answer highlighted -->
                    <div class="options-container result-options">
                        {% for option in q.options %}
                            {% set i = loop.index0 %}
                            {% set user_selected = (i|string in question_result.user_answer) %}
                            {% set score_value = q.scoring[i]|float %}
                            {% set is_correct_answer = (score_value > 0) %}
                            
                            <div class="result-option 
                                {% if user_selected and is_correct_answer %}result-option-correct
                                {% elif user_selected and not is_correct_answer %}result-option-wrong
                                {% elif not user_selected and is_correct_answer %}result-option-missed
                                {% else %}result-option-other
                                {% endif %}"
                            >
                                <div class="option-content">
                                    <!-- <div class="option-text">{{ option }}</div> -->
                                    {{ render_option(option, q.type_of_answer, loop.index0) }}
                                    
                                    <!-- Show badges for user selection and correct answer -->
                                    <div class="option-badges">
                                        {% if user_selected %}
                                            <span class="badge badge-user">Sua resposta</span>
                                        {% endif %}
                                        
                                        {% if is_correct_answer %}
                                            <span class="badge badge-correct">Correto</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Show score for this option -->
                                <div class="option-score">
                                    <span class="score-value 
                                        {% if score_value > 0 %}score-positive
                                        {% elif score_value < 0 %}score-negative
                                        {% else %}score-neutral
                                        {% endif %}"
                                    >
                                        {{ score_value|int if score_value == score_value|int else score_value }}
                                    </span>
                                </div>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Summary for this question -->
                    {% if result_type != 'skipped' %}
                    <div class="question-summary">
                        <div class="summary-row">
                            <span class="summary-label">Pontos obtidos:</span>
                            <span class="summary-value {% if question_result.points > 0 %}positive{% else %}negative{% endif %}">
                                {{ question_result.points }}
                            </span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>
    
    {% else %}
        <!-- Anonymous user - show signup incentive -->
        <div class="results-details-locked">
            <div class="locked-message">
                <h3>üîí Detalhes das Respostas</h3>
                <p>Para ver os detalhes de suas respostas e manter um hist√≥rico permanente, 
                   <a href="{{ url_for('signin.signin', next_uuid=quiz_uuid) }}">fa√ßa login</a> ou 
                   <a href="{{ url_for('signin.signin', next_uuid=quiz_uuid) }}">crie uma conta</a>.</p>
                {% if quiz_uuid %}
                <p class="uuid-info">
                    ID do Quiz: <code>{{ quiz_uuid }}</code><br>
                    <small>‚è∞ Dispon√≠vel por 1 hora</small>
                </p>
                {% endif %}
            </div>
        </div>
    {% endif %}

    <p>Perguntas: MATEMATICA.PT &copy; 2025 - Vitor Nunes</p>
    <p>Respostas: EXPLICACOESLISBOA.PT &copy; 2025 - M√°rio Sousa</p>
    <br>

    <!-- Action buttons -->
    <div class="results-actions">
    {% if source == 'profile' %}
        <a href="{{ url_for('profile.profile') }}" class="btn btn-secondary">Voltar ao perfil</a>
        <a href="{{ url_for('quiz.quiz_config') }}" class="btn btn-primary">Fazer um novo quiz</a>
    {% else %}
        <a href="{{ url_for('quiz.start_quiz', year=config.year, num_exercises=config.num_exercises, current_year_percent=config.current_year_percent) }}" class="btn btn-primary">
            Come√ßar de novo
        </a>
        <a href="{{ url_for('quiz.quiz_config', year=config.year, num_exercises=config.num_exercises, current_year_percent=config.current_year_percent) }}" class="btn btn-secondary">
            Alterar configura√ß√µes
        </a>
    {% endif %}
</div>
</div>

<!-- Add inline styles for the result options -->
<style>
    .result-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        padding: 12px;
        margin-bottom: 8px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: #f9f9fb;
        transition: all 0.2s ease;
    }

    @media (prefers-color-scheme: dark) {
  .result-option {
    background: #0f172a;      /* dark slate */
    border-color: #1f2a44;    /* muted border */
  }
}
    .option-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .option-text {
        font-weight: 500;
        color: #1f2937;
    }

    .option-badges {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-user {
        background: #dbeafe;
        color: #0c4a6e;
    }

    .badge-correct {
        background: #d1fae5;
        color: #065f46;
    }

    .option-score {
        font-weight: 700;
        font-size: 18px;
        min-width: 40px;
        text-align: right;
    }

    .score-value {
        display: block;
    }

    .score-positive {
        color: #10b981;
    }

    .score-negative {
        color: #ef4444;
    }

    .score-neutral {
        color: #9ca3af;
    }

    /* Result option states -->
    .result-option-correct {
        background: #ecfdf5;
        border-color: #10b981;
    }

    .result-option-wrong {
        background: #fef2f2;
        border-color: #ef4444;
    }

    .result-option-missed {
        background: #fffbeb;
        border-color: #f59e0b;
    }

    .result-option-other {
        background: #f9fafb;
        border-color: #e5e7eb;
    }

    .option-text {
        color: #1f2937;
    }

    .result-option-wrong .option-text {
        color: #7f1d1d;
    }

    .result-option-missed .option-text {
        color: #78350f;
    }

    .question-summary {
        margin-top: 16px;
        padding: 12px;
        background: #f3f4f6;
        border-radius: 8px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .summary-label {
        font-weight: 500;
        color: #6b7280;
    }

    .summary-value {
        font-weight: 700;
        font-size: 18px;
    }

    .summary-value.positive {
        color: #10b981;
    }

    .summary-value.negative {
        color: #ef4444;
    }

    /* Dark mode -->
    @media (prefers-color-scheme: dark) {
        .result-option {
            background: #1e293b;
            border-color: #314575;
        }

        .option-text {
            color: #e6efff;
        }

        .result-option-correct {
            background: #0f3f2d;
            border-color: #10b981;
        }

        .result-option-wrong {
            background: #3f1010;
            border-color: #ef4444;
        }

        .result-option-missed {
            background: #3d2a0d;
            border-color: #f59e0b;
        }

        .result-option-other {
            background: #1e293b;
            border-color: #314575;
        }

        .result-option-wrong .option-text {
            color: #fed7d7;
        }

        .result-option-missed .option-text {
            color: #fef3c7;
        }

        .badge-user {
            background: #0c4a6e;
            color: #dbeafe;
        }

        .badge-correct {
            background: #065f46;
            color: #d1fae5;
        }

        .question-summary {
            background: #203157;
        }

        .summary-label {
            color: #9ca3af;
        }
    }

    /* Results layout -->
    .result-question-card {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #e5e7eb;
    }

    .result-correct {
        border-left-color: #10b981;
    }

    .result-wrong {
        border-left-color: #ef4444;
    }

    .result-skipped {
        border-left-color: #f59e0b;
        opacity: 0.9;
    }

    .result-question-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }

    .header-left {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .question-number {
        font-weight: 600;
        color: var(--blue-title);
    }

    .header-right {
        font-weight: 600;
        color: var(--blue-title);
    }

    .answers-comparison {
        margin-top: 16px;
    }

    .answers-comparison h3 {
        font-size: 1rem;
        color: var(--blue-title);
        margin-bottom: 12px;
    }

    @media (prefers-color-scheme: dark) {
        .result-question-card {
            background: #1b2a4a;
            border-color: #314575;
        }

        .answers-comparison h3 {
            color: var(--yellow-header);
        }

        .question-summary {
            background: #0f1a2e;
        }
    }

    @media (max-width: 768px) {
        .result-question-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .result-option {
            flex-direction: column;
            align-items: flex-start;
        }

        .option-score {
            align-self: flex-start;
        }
    }
</style>